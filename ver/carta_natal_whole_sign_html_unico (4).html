<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carta Natal — Whole Sign (HTML único)</title>
  <!--
    Cambios en esta versión:
    - Selector de zona horaria IANA por ciudades (no numérico). Fallback incluido.
    - ASC ahora es un **grado** marcado con una muesca y etiqueta (no la línea de borde de casa).
    - DC/IC se calculan desde el ASC real (ASC+180, MC+180).
    - Etiquetas de casas I–XII y listado de casas con su signo y planetas.
    - Capa de **dignidades** visible (halo + badge) y test arreglado; añadida exaltación de Saturno en Libra.
    - Modo "hora desconocida" revisado: explora franjas, elige signo ascendente y dibuja; se ocultan ángulos.
    - Modo **presentación**: tras dibujar se oculta el formulario, aparece una barra superior (Editar / Exportar / Dignidades).
    - Estilo más "místico": tipografía serif para etiquetas, numerales romanos, halo suave y fondo estrellado.
  -->
  <style>
    :root{
      --bg:#06070d; --space1:#090b14; --space2:#0d1020; --panel:#0f1222; --accent:#80eaff; --muted:#9fb3c8;
      --ok:#7CFFB6; --warn:#ffd166; --err:#ff6b6b; --ring:#2a3b58; --line:#223048;
    }
    html,body{height:100%; margin:0; background:radial-gradient(1200px 800px at 70% -10%, var(--space2), var(--bg)); color:#e8eef6; font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    @media (prefers-color-scheme: light){ body{background:#0b0e19;} }
    h1{font-weight:700; letter-spacing:.2px; font-size:18px; margin:8px 0 12px}
    .wrap{max-width:1220px; margin:0 auto; padding:16px; display:grid; gap:16px; grid-template-columns: 420px 1fr}
    .card{background:linear-gradient(180deg,rgba(22,26,50,.9),rgba(10,12,24,.9)); border:1px solid #172036; border-radius:16px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.35)}
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 4px}
    input,select,button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #283142; background:#0f141d; color:#e8eef6}
    .row{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    .row3{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr}
    button{cursor:pointer; background:#0f1724; border-color:#2a3752; transition:transform .06s ease}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(180deg,#2b8fff,#1466ff); border:none}
    .muted{color:var(--muted)}
    .legend{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; font-feature-settings:"tnum" 1}
    .legend div{background:#0b111b; border:1px solid #20283a; border-radius:10px; padding:8px}
    canvas{width:100%; height:auto; background:radial-gradient(800px 800px at 50% 35%, rgba(255,255,255,.03), rgba(0,0,0,.0)), #090c16; border-radius:16px; display:block}
    .small{font-size:12px; color:#b9cbe2}
    .inline{display:flex; gap:8px; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#0b111b; border:1px solid #20283a; border-radius:999px; padding:4px 10px; font-size:12px}
    .right{justify-content:flex-end}
    .tip{margin-top:6px; font-size:12px; color:#b9cbe2}
    .foot{opacity:.7; font-size:12px}
    .test{margin-top:10px}
    .pass{color:var(--ok)}
    .fail{color:var(--err)}
    .grid{display:grid; gap:8px}
    .grid2{grid-template-columns:1fr 1fr}
    .badge{display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; border:1px solid #2a3752}
    .dom{background:#0f2b21; border-color:#1c6e4b; color:#9bffcb}
    .ex{background:#2a250f; border-color:#8e7c2a; color:#ffe28a}
    .det{background:#2b1111; border-color:#8a3434; color:#ffb3b3}
    .fall{background:#2b1a0f; border-color:#8a4b2a; color:#ffc2a3}
    .pe{background:#10141c; color:#b8c7dc}

    /* Tipografía "mística" para casas/signos */
    .serif{font-family:"Spectral SC", "Cormorant Garamond", Georgia, serif}

    /* Barra superior en modo presentación */
    #toolbar{position:sticky; top:0; z-index:5; display:none; gap:8px; padding:8px; background:linear-gradient(180deg, rgba(12,16,28,.85), rgba(12,16,28,.55)); backdrop-filter:blur(6px); border-bottom:1px solid #1a2440}
    #toolbar .rowbar{display:flex; gap:8px; align-items:center; justify-content:space-between; max-width:1220px; margin:0 auto}
    #toolbar .left, #toolbar .right{display:flex; gap:8px; align-items:center}

    /* Modo presentación: ocultar formulario */
    body.presentation .wrap{grid-template-columns: 1fr}
    body.presentation .wrap > .card:first-child{display:none}
    body.presentation #toolbar{display:block}
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="rowbar">
      <div class="left serif" style="letter-spacing:.06em">☿ Carta Natal — Whole Sign</div>
      <div class="right">
        <button id="btnBack" class="pill">Editar parámetros</button>
        <button id="btnToggleDigs" class="pill">Dignidades: <span id="digsState">off</span></button>
        <button id="btnExport" class="pill">Exportar PNG</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>⚝ Carta Natal — Whole Sign</h1>

      <div class="row">
        <div>
          <label>Nombre (opcional)</label>
          <input id="name" placeholder="p.ej. Manu"/>
        </div>
        <div>
          <label>Zona horaria (IANA / ciudades)</label>
          <select id="tzSelect"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fecha</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label class="inline"><span>Hora</span>
            <span class="inline" style="gap:6px">
              <input id="time" type="time" step="60" />
              <label class="inline" style="gap:6px; font-size:12px"><input type="checkbox" id="chkUnknownTime"> No conozco mi hora</label>
            </span>
          </label>
        </div>
      </div>

      <label>Localización (búsqueda opcional)</label>
      <div class="row">
        <input id="q" placeholder="Ciudad, país (p.ej. Barcelona, ES)">
        <button id="btnGeo">Buscar</button>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Latitud (°)</label>
          <input id="lat" type="number" step="0.000001" placeholder="41.388" />
        </div>
        <div>
          <label>Longitud (°, Este positivo)</label>
          <input id="lon" type="number" step="0.000001" placeholder="2.170" />
        </div>
      </div>

      <div class="row3" style="margin-top:12px">
        <button class="pill" id="btnNow">Ahora/aquí</button>
        <button id="btnDraw" class="primary">Dibujar carta</button>
        <label class="inline" style="gap:6px; justify-content:flex-end"><input type="checkbox" id="chkDignities"> Mostrar dignidades</label>
      </div>

      <div id="unknownZone" style="display:none; margin-top:8px" class="grid grid2">
        <button id="btnScan" class="pill">Explorar ascendentes del día</button>
        <select id="ascPick"></select>
        <div id="scanSummary" class="small" style="grid-column:1/-1"></div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnTest" class="pill">Autotest</button>
        <button id="btnExample" class="pill">Cargar ejemplo</button>
      </div>

      <div class="tip">El selector de zona horaria usa IANA y ajusta DST automáticamente. Si el gráfico no aparece, puede que el navegador bloquee la librería astronómica; hay 3 CDNs de respaldo.</div>
      <div id="status" class="tip"></div>
      <div id="testout" class="test"></div>
      <div class="small foot" style="margin-top:10px">Precisión: posiciones planetarias ~±1′ (Astronomy Engine). Asc/MC por fórmulas astronómicas estándar. Tropical + casas de <i>Whole Sign</i>.</div>
    </div>

    <div class="card">
      <canvas id="chart" width="1000" height="1000"></canvas>
      <div id="readout" class="legend" style="margin-top:12px"></div>
      <div id="houses" class="legend serif" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ===== Utilidades UI =====
    const $ = sel => document.querySelector(sel);
    function setStatus(msg, kind='info'){ const el=$('#status'); el.textContent = msg; el.style.color = (kind==='error'? '#ff6b6b' : '#b9cbe2'); }

    function roman(n){ const R=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII']; return R[n]||String(n); }

    // ===== LOADER ROBUSTO DE ASTRONOMY ENGINE =====
    async function loadAstronomy(){
      if(window.Astronomy) return true;
      const urls = [
        'https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.browser.min.js',
        'https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.browser.js',
        'https://unpkg.com/astronomy-engine@2.1.0/astronomy.browser.js'
      ];
      for(const url of urls){
        try{
          await new Promise((resolve, reject)=>{
            const s = document.createElement('script'); s.src = url; s.defer = true; s.onload = ()=>resolve(); s.onerror = ()=>reject(new Error('No se pudo cargar '+url)); document.head.appendChild(s);
          });
          if(window.Astronomy){ return true; }
        }catch(err){ /* intentar siguiente */ }
      }
      return false;
    }

    // ===== Matemáticas auxiliares =====
    const deg2rad = d => d*Math.PI/180;
    const rad2deg = r => (r*180/Math.PI);
    const norm = d => ((d%360)+360)%360;

    // ===== Tiempo astronómico y TZ =====
    function julianDayUTC(date){ let y = date.getUTCFullYear(); let m = date.getUTCMonth()+1; const dayFrac = (date.getUTCHours() + date.getUTCMinutes()/60)/24; let d = date.getUTCDate() + dayFrac; if(m<=2){m+=12; y-=1;} const A=Math.floor(y/100); const B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + d + B - 1524.5; }
    function julianCenturies(date){ return (julianDayUTC(date)-2451545)/36525; }
    function obliquityEcliptic(date){ const T=julianCenturies(date); const arcsec=21.448-46.8150*T-0.00059*T*T+0.001813*T*T*T; return 23+26/60+arcsec/3600; }
    function gmstHours(date){ const T=julianCenturies(date); let gmst=(67310.548+(3155760000+8640184.812866)*T+0.093104*T*T-6.2e-6*T*T*T)/3600; return ((gmst%24)+24)%24; }

    function partsToObj(parts){ const o={}; for(const p of parts){ o[p.type]=p.value; } return o; }
    function makeFormatter(tz){ return new Intl.DateTimeFormat('en-US',{timeZone:tz,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
    function localToUTC(tz,Y,M,D,h,m){ let guess = Date.UTC(Y,M-1,D,h,m,0); const f = makeFormatter(tz); for(let i=0;i<4;i++){ const parts=partsToObj(f.formatToParts(new Date(guess))); const got=Date.UTC(+parts.year, +parts.month-1, +parts.day, +parts.hour, +parts.minute, 0); const target=Date.UTC(Y,M-1,D,h,m,0); const diff=got-target; if(Math.abs(diff)<1000) break; guess -= diff; } return new Date(guess); }

    function ascendantLongitude(dateUTC, latDeg, lonDeg){ const eps=deg2rad(obliquityEcliptic(dateUTC)); const phi=deg2rad(latDeg); const thetaL=deg2rad(gmstHours(dateUTC)*15 + lonDeg); const num=Math.cos(thetaL); const den=-(Math.sin(thetaL)*Math.cos(eps) + Math.tan(phi)*Math.sin(eps)); return norm(rad2deg(Math.atan2(num, den))); }
    function midheavenLongitude(dateUTC, lonDeg){ const eps=deg2rad(obliquityEcliptic(dateUTC)); const thetaL=deg2rad(gmstHours(dateUTC)*15 + lonDeg); return norm(rad2deg(Math.atan2(Math.sin(thetaL), Math.cos(thetaL)*Math.cos(eps)))); }

    // ===== Posiciones eclípticas (requiere Astronomy) =====
    function eclipticLongitude(bodyKey, astroTime){ let vec; if(bodyKey==='Moon') vec=Astronomy.GeoMoon(astroTime); else vec=Astronomy.GeoVector(bodyKey, astroTime, true); const eps=deg2rad(obliquityEcliptic(astroTime.date)); const x=vec.x, y=vec.y, z=vec.z; const ye=y*Math.cos(eps)+z*Math.sin(eps); const xe=x; return norm(rad2deg(Math.atan2(ye, xe))); }

    function formatZodiac(lon){ const s=Math.floor(lon/30); const deg=Math.floor(lon - s*30); const min=Math.floor((lon - s*30 - deg)*60); const glyph=['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'][s]; const names=['Aries','Tauro','Géminis','Cáncer','Leo','Virgo','Libra','Escorpio','Sagitario','Capricornio','Acuario','Piscis']; return `${deg}°${min.toString().padStart(2,'0')} ${glyph} (${names[s]})`; }

    // ===== Dignidades esenciales (tradicional) =====
    const RULERS = {0:'Mars',1:'Venus',2:'Mercury',3:'Moon',4:'Sun',5:'Mercury',6:'Venus',7:'Mars',8:'Jupiter',9:'Saturn',10:'Saturn',11:'Jupiter'}; // regentes
    const EXALT_FULL = {0:'Sun',1:'Moon',5:'Mercury',9:'Mars',3:'Jupiter',11:'Venus',6:'Saturn'}; // exaltaciones clásicas
    function dignityOf(planet, sign){ const trad=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn']; if(!trad.includes(planet)) return 'pe'; if(RULERS[sign]===planet) return 'dom'; if(EXALT_FULL[sign]===planet) return 'ex'; const opp=(sign+6)%12; if(RULERS[opp]===planet) return 'det'; if(EXALT_FULL[opp]===planet) return 'fall'; return 'pe'; }
    const DIG_COL = { dom:'#7CFFB6', ex:'#ffd166', det:'#ff6b6b', fall:'#ff9966', pe:'#9fb3c8' };

    // ===== Dibujo de rueda Whole Sign =====
    function drawChart(data){
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height; ctx.clearRect(0,0,W,H);
      const cx = W/2, cy = H/2; const R = 430; const rHouse = 360; const rPlan = 290; const rSigns = 395; const rASC = 420; const rNums = 210;

      // Fondo con estrellas suaves
      ctx.save();
      ctx.fillStyle = '#090c16'; ctx.fillRect(0,0,W,H);
      for(let i=0;i<120;i++){ const x=Math.random()*W, y=Math.random()*H, r=Math.random()*1.2; ctx.globalAlpha = Math.random()*0.7+0.2; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle = 'white'; ctx.fill(); }
      ctx.globalAlpha = 1; ctx.restore();

      // 12 casas (Whole Sign) desde 0° del signo ascendente
      for(let i=0;i<12;i++){
        const start = (Math.PI) + (i*30)*Math.PI/180;
        const end   = (Math.PI) + ((i+1)*30)*Math.PI/180;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,end); ctx.closePath();
        ctx.fillStyle = i%2? '#0e1424' : '#0b1120'; ctx.fill();
      }

      // Líneas de casa
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line')||'#223048'; ctx.lineWidth = 2.2;
      for(let i=0;i<12;i++){ const ang=Math.PI + (i*30)*Math.PI/180; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + R*Math.cos(ang), cy + R*Math.sin(ang)); ctx.stroke(); }

      // Bisel interno
      ctx.beginPath(); ctx.arc(cx,cy,rHouse,0,Math.PI*2); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ring')||'#2a3b58'; ctx.lineWidth=2; ctx.stroke();

      // Signos en el borde externo y numerales romanos
      const signGlyph = ['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'];
      const signNames = ['Aries','Tauro','Géminis','Cáncer','Leo','Virgo','Libra','Escorpio','Sagitario','Capricornio','Acuario','Piscis'];
      for(let i=0;i<12;i++){
        const ang = Math.PI + ((i+0.5)*30)*Math.PI/180;
        const x = cx + rSigns*Math.cos(ang), y = cy + rSigns*Math.sin(ang)+6;
        const signIndex = (data.ascSign + i) % 12;
        ctx.fillStyle = '#d7ecff'; ctx.font = '30px "Segoe UI Symbol", system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(signGlyph[signIndex], x, y);
        // Numeral de casa
        const xn = cx + rNums*Math.cos(ang), yn = cy + rNums*Math.sin(ang);
        ctx.fillStyle = '#aac0db'; ctx.font = '16px "Spectral SC", Georgia, serif'; ctx.fillText(roman(i+1), xn, yn);
      }

      // Ángulos: ASC (grado), MC (línea), DC/IC (líneas) si hay hora
      if(!data.unknownTime){
        // Marcador de ASC grado real
        const ascRel = norm(data.ascDeg - data.house0); const a = Math.PI + ascRel*Math.PI/180;
        ctx.strokeStyle = '#7CFFB6'; ctx.lineWidth = 3.5; ctx.beginPath(); ctx.moveTo(cx + (rASC-18)*Math.cos(a), cy + (rASC-18)*Math.sin(a)); ctx.lineTo(cx + (rASC)*Math.cos(a), cy + (rASC)*Math.sin(a)); ctx.stroke();
        ctx.save(); ctx.translate(cx + (rASC+14)*Math.cos(a), cy + (rASC+14)*Math.sin(a)); ctx.rotate(a+Math.PI/2); ctx.fillStyle = '#7CFFB6'; ctx.font='bold 12px system-ui'; ctx.textAlign='center'; ctx.fillText(`ASC ${formatZodiac(data.ascDeg).split(' ')[0]}`, 0, 0); ctx.restore();
        // MC / DC / IC
        const drawAxis = (label, lon, color)=>{ const rel = norm(lon - data.house0); const ang = Math.PI + rel*Math.PI/180; ctx.strokeStyle=color; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + R*Math.cos(ang), cy + R*Math.sin(ang)); ctx.stroke(); ctx.save(); ctx.translate(cx + (R+18)*Math.cos(ang), cy + (R+18)*Math.sin(ang)); ctx.rotate(ang+Math.PI/2); ctx.fillStyle=color; ctx.font='bold 12px system-ui'; ctx.textAlign='center'; ctx.fillText(label,0,0); ctx.restore(); };
        drawAxis('MC', data.mc, '#ffd166');
        drawAxis('DC', norm(data.ascDeg+180), '#7CFFB6');
        drawAxis('IC', norm(data.mc+180), '#ffd166');
      }

      // Planetas (con halo de dignidad si procede)
      for(const p of data.planets){
        const rel = norm(p.lon - data.house0); const ang = Math.PI + rel*Math.PI/180; const x = cx + rPlan*Math.cos(ang), y = cy + rPlan*Math.sin(ang);
        if(data.showDignities && p.dig){ ctx.beginPath(); ctx.arc(x,y,15,0,Math.PI*2); ctx.strokeStyle = DIG_COL[p.dig]||'#3b517a'; ctx.shadowColor = DIG_COL[p.dig]||'#3b517a'; ctx.shadowBlur=10; ctx.lineWidth=3; ctx.stroke(); ctx.shadowBlur=0; }
        ctx.beginPath(); ctx.arc(x,y,11,0,Math.PI*2); ctx.fillStyle = '#152033'; ctx.fill(); ctx.strokeStyle='#3b517a'; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle = '#eaf3ff'; ctx.font='19px "Segoe UI Symbol", system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.glyph, x, y);
      }

      // Anillo interior
      ctx.beginPath(); ctx.arc(cx,cy,195,0,Math.PI*2); ctx.strokeStyle='#24324b'; ctx.lineWidth=2; ctx.stroke();
    }

    // ===== Datos planetarios + pipeline =====
    const planetList = [
      {key:'Sun', glyph:'☉', name:'Sol'},
      {key:'Moon', glyph:'☽', name:'Luna'},
      {key:'Mercury', glyph:'☿', name:'Mercurio'},
      {key:'Venus', glyph:'♀', name:'Venus'},
      {key:'Mars', glyph:'♂', name:'Marte'},
      {key:'Jupiter', glyph:'♃', name:'Júpiter'},
      {key:'Saturn', glyph:'♄', name:'Saturno'},
      {key:'Uranus', glyph:'♅', name:'Urano'},
      {key:'Neptune', glyph:'♆', name:'Neptuno'},
      {key:'Pluto', glyph:'♇', name:'Plutón'}
    ];

    function computePlanets(utc){ const t=new Astronomy.AstroTime(utc); return planetList.map(p=>{ const lon=eclipticLongitude(p.key, t); const sign=Math.floor(lon/30); const dig=dignityOf(p.key, sign); return {name:p.name, key:p.key, glyph:p.glyph, lon, sign, dig}; }); }

    function assignHouses(planets, ascSign){
      // Whole Sign: casa n corresponde al signo (ascSign + n-1)
      const houses = Array.from({length:12}, ()=>({sign:null, planets:[]}));
      for(let i=0;i<12;i++){ houses[i].sign = (ascSign + i) % 12; }
      for(const p of planets){ const s = Math.floor(p.lon/30); // signo del planeta
        for(let h=0; h<12; h++){ if(houses[h].sign===s){ houses[h].planets.push(p); break; } }
      }
      return houses;
    }

    function computeAndDraw(){
      if(!window.Astronomy){ setStatus('No se ha cargado Astronomy Engine. Revisa conexión o políticas del navegador.', 'error'); return; }
      const name = $('#name').value.trim(); const dateStr=$('#date').value; if(!dateStr){ setStatus('→ Falta fecha.'); return; }
      const lat=parseFloat($('#lat').value); const lon=parseFloat($('#lon').value); if(isNaN(lat)||isNaN(lon)){ setStatus('→ Faltan coordenadas.'); return; }
      const tz=$('#tzSelect').value; const unknown=$('#chkUnknownTime').checked; const showDig=$('#chkDignities').checked;

      const [Y,M,D]=dateStr.split('-').map(Number); let utc; if(unknown){ utc = localToUTC(tz, Y,M,D, 12,0); } else { const timeStr=$('#time').value||'12:00'; const [hh,mm]=timeStr.split(':').map(Number); utc = localToUTC(tz, Y,M,D, hh, mm||0); }

      const planets = computePlanets(utc);
      let ascDeg=null, mc=null, ascSign, house0;
      if(unknown){ const pick=$('#ascPick').value; ascSign = pick? parseInt(pick,10) : 0; house0 = ascSign*30; }
      else { ascDeg = ascendantLongitude(utc, lat, lon); mc = midheavenLongitude(utc, lon); ascSign = Math.floor(ascDeg/30); house0 = ascSign*30; }

      drawChart({planets, house0, ascSign, ascDeg, mc, unknownTime: unknown, showDignities: showDig});

      // Leyenda (planetas)
      const ro=$('#readout'); ro.innerHTML='';
      const hdr=document.createElement('div'); const tzName=tz; const ts = unknown? '' : ($('#time').value||'12:00 ');
      hdr.innerHTML = `<b>${name||'Carta natal'}</b><br><span class="muted">${dateStr} ${ts}${tzName}, lat ${lat.toFixed(4)}°, lon ${lon.toFixed(4)}°</span>` + (unknown? `<br><span class="muted">Hora desconocida — ángulos ocultos</span>` : '');
      hdr.style.gridColumn='1 / -1'; ro.appendChild(hdr);
      for(const p of planets){ const d=document.createElement('div'); const digText={dom:'Domicilio',ex:'Exaltación',det:'Detrimento',fall:'Caída',pe:'Peregrino'}[p.dig]; const badge=`<span class="badge ${p.dig}">${digText}</span>`; d.innerHTML = `<div class="inline"><span class="pill">${p.glyph} ${p.name}</span><span class="muted">${formatZodiac(p.lon)}</span>${ showDig? '&nbsp;'+badge : ''}</div>`; ro.appendChild(d); }

      // Listado de casas con signo y planetas
      const hs=$('#houses'); hs.innerHTML=''; const houses=assignHouses(planets, ascSign);
      const signNames=['Aries','Tauro','Géminis','Cáncer','Leo','Virgo','Libra','Escorpio','Sagitario','Capricornio','Acuario','Piscis'];
      for(let i=0;i<12;i++){ const h=houses[i]; const div=document.createElement('div'); const plist = h.planets.length? h.planets.map(p=>`${p.glyph} ${p.name}`).join(' · ') : '<span class="muted">—</span>'; div.innerHTML = `<b class="serif">Casa ${roman(i+1)}</b> — ${signNames[h.sign]} &nbsp; <span class="muted">Planetas:</span> ${plist}`; hs.appendChild(div); }

      setStatus('');
      // Activar modo presentación y sincronizar barra
      document.body.classList.add('presentation'); updateToolbar(showDig);
    }

    function updateToolbar(showDig){ $('#digsState').textContent = showDig? 'on':'off'; }

    // ===== Escaneo de ascendentes del día (hora desconocida) =====
    function scanAscendants(){ const dateStr=$('#date').value; const tz=$('#tzSelect').value; const lat=parseFloat($('#lat').value); const lon=parseFloat($('#lon').value); if(!dateStr||isNaN(lat)||isNaN(lon)){ setStatus('→ Para explorar, indica fecha y coordenadas.'); return; } const [Y,M,D]=dateStr.split('-').map(Number); const stepMin=20; const signs=[]; const ranges=[]; let lastSign=null; let startMin=0; for(let minutes=0; minutes<24*60; minutes+=stepMin){ const hh=Math.floor(minutes/60); const mm=minutes%60; const utc=localToUTC(tz, Y,M,D, hh, mm); const asc=ascendantLongitude(utc, lat, lon); const s=Math.floor(asc/30); if(lastSign===null){ lastSign=s; startMin=minutes; } if(s!==lastSign){ ranges.push([lastSign,startMin,minutes]); signs.push(lastSign); lastSign=s; startMin=minutes; } } ranges.push([lastSign,startMin,24*60]); signs.push(lastSign); const uniq=[]; const seen=new Set(); for(const s of signs){ if(!seen.has(s)){ seen.add(s); uniq.push(s); } } const sel=$('#ascPick'); sel.innerHTML=''; for(const s of uniq){ const opt=document.createElement('option'); opt.value=String(s); opt.textContent=['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'][s] + ' — posible'; sel.appendChild(opt); } function mmToStr(m){ const h=String(Math.floor(m/60)).padStart(2,'0'); const mi=String(m%60).padStart(2,'0'); return `${h}:${mi}`; } const g=ranges.map(r=>`${['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'][r[0]]}: ${mmToStr(r[1])}–${mmToStr(r[2])}`).join(' · '); $('#scanSummary').innerHTML = `<b>Ascendentes a lo largo del día:</b><br>${g}<br><span class="muted">Con Whole Sign, las casas son por signo; lo que cambia con el ascendente elegido es en qué casa cae cada planeta.</span>`; setStatus('Listo. Elige un ascendente y pulsa “Dibujar carta”.'); }

    // ===== Geocoder (OSM) =====
    async function geocode(){ const q=$('#q').value.trim(); if(!q){return} setStatus('Buscando…'); try{ const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`; const res=await fetch(url,{headers:{'Accept-Language':'es'}}); const arr=await res.json(); if(arr&&arr.length){ $('#lat').value=parseFloat(arr[0].lat).toFixed(6); $('#lon').value=parseFloat(arr[0].lon).toFixed(6); setStatus(`📍 ${arr[0].display_name}`); } else { setStatus('No encontrado.'); } }catch(err){ setStatus('Error de red al geocodificar.', 'error'); } }

    // ===== TZ: popular selector con IANA =====
    function populateTZ(){ const sel=$('#tzSelect'); sel.innerHTML=''; let zones=[]; if(Intl.supportedValuesOf){ try{ zones=Intl.supportedValuesOf('timeZone'); }catch(_){} } if(!zones||zones.length===0){ zones=['Europe/Madrid','Europe/Paris','Europe/London','Europe/Rome','Europe/Berlin','Europe/Lisbon','UTC','Africa/Casablanca','Africa/Johannesburg','America/Sao_Paulo','America/Argentina/Buenos_Aires','America/Mexico_City','America/Bogota','America/Lima','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Asia/Tokyo','Asia/Seoul','Asia/Shanghai','Asia/Hong_Kong','Asia/Kolkata','Asia/Bangkok','Asia/Dubai','Australia/Sydney']; }
      const current = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; for(const z of zones){ const opt=document.createElement('option'); opt.value=z; opt.textContent=z; if(z===current) opt.selected=true; sel.appendChild(opt); } }

    // ===== Defaults: ahora/aquí =====
    function fillNow(){ populateTZ(); const d=new Date(); $('#date').valueAsDate = new Date(d.getFullYear(), d.getMonth(), d.getDate()); $('#time').value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{ $('#lat').value = pos.coords.latitude.toFixed(6); $('#lon').value = pos.coords.longitude.toFixed(6); setStatus('Coordenadas obtenidas del dispositivo.'); }, _=>{}, {enableHighAccuracy:true, timeout:4000}); } }

    // ===== Export PNG =====
    function exportPNG(){ const canvas=$('#chart'); const link=document.createElement('a'); link.download = `carta_whole_sign.png`; link.href = canvas.toDataURL('image/png'); link.click(); }

    // ===== Autotests =====
    function addTestLine(msg, ok){ const el=document.createElement('div'); el.innerHTML = `${ok? '✅' : '❌'} <span class="${ok? 'pass':'fail'}">${msg}</span>`; $('#testout').appendChild(el); }
    function clearTests(){ $('#testout').innerHTML=''; }
    function runTests(){ clearTests(); addTestLine('Carga de Astronomy Engine', !!window.Astronomy); if(!window.Astronomy){ addTestLine('Sin Astronomy no se pueden calcular planetas.', false); return; } try{ const utc=new Date(Date.UTC(2024,0,1,12,0,0)); const t=new Astronomy.AstroTime(utc); const bodies=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto']; let okAll=true; for(const b of bodies){ const lon=eclipticLongitude(b,t); if(!(isFinite(lon)&&lon>=0&&lon<360)) okAll=false; } addTestLine('Longitudes planetarias dentro de [0,360)', okAll); }catch(e){ addTestLine('Error calculando longitudes: '+e.message, false); }
      try{ const utc=new Date(Date.UTC(2024,5,1,12,0,0)); const asc=ascendantLongitude(utc,41.387,2.170); const mc=midheavenLongitude(utc,2.170); addTestLine('ASC rango [0,360)', asc>=0&&asc<360); addTestLine('MC rango [0,360)', mc>=0&&mc<360); }catch(e){ addTestLine('Error en ASC/MC: '+e.message, false); }
      // Dignidades correctas
      const digsOK = dignityOf('Mars',0)==='dom' && dignityOf('Sun',0)==='ex' && dignityOf('Saturn',6)==='ex' && dignityOf('Saturn',3)==='det';
      addTestLine('Dignidades: reglas base', digsOK);
    }

    // ===== Listeners =====
    $('#btnGeo').addEventListener('click', geocode);
    $('#btnDraw').addEventListener('click', computeAndDraw);
    $('#btnNow').addEventListener('click', ()=>{ fillNow(); setStatus(''); });
    $('#btnTest').addEventListener('click', runTests);
    $('#btnExample').addEventListener('click', ()=>{ $('#name').value='Ejemplo'; $('#date').value='1997-02-28'; $('#time').value='15:40'; $('#lat').value='36.600000'; $('#lon').value='-6.216667'; setStatus('Ejemplo cargado. Si no conoces la hora, marca la casilla.'); });
    $('#chkUnknownTime').addEventListener('change', (e)=>{ const on=e.target.checked; $('#time').disabled=on; $('#unknownZone').style.display = on? 'grid':'none'; if(on) setStatus('Modo hora desconocida: explora ascendentes y elige uno para dibujar.'); else setStatus(''); });
    $('#btnScan').addEventListener('click', scanAscendants);

    // Toolbar
    $('#btnBack').addEventListener('click', ()=>{ document.body.classList.remove('presentation'); });
    $('#btnExport').addEventListener('click', exportPNG);
    $('#btnToggleDigs').addEventListener('click', ()=>{ const chk=$('#chkDignities'); chk.checked = !chk.checked; updateToolbar(chk.checked); /* redibujar con estado */ computeAndDraw(); });

    // ===== Bootstrap =====
    (async function init(){ fillNow(); setStatus('Cargando librería astronómica…'); const ok=await loadAstronomy(); if(ok){ setStatus('Librería lista.'); } else { setStatus('No se pudo cargar Astronomy Engine desde los CDNs. El dibujo funcionará, pero sin planetas.', 'error'); } })();
  </script>
</body>
</html>
