<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>carta natal — whole sign (html único)</title>
  <!--
    v7.3 — fondo de estrellas + tipografía de signos sin emoji + tabla en una columna
    - Fondo cósmico con canvas de estrellas (basado en tu index.html) fijo detrás de todo.
    - Signos del zodiaco forzados a glifo de **texto** (no emoji) usando VS-15 y fuentes de símbolos.
    - Leyendas/tablas en **una columna** (planetas, aspectos, casas) sin scroll ni separadores.
    - Párrafos intro explicativos: dignidades, aspectos, ángulos (asc/mc/dc/ic) y casas (helenístico).
    - Mantiene los tests y el fix previo de `data`.
  -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Spectral+SC:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07050a; --space:#090714; --ink:#efe9ff; --muted:#b7acd6; --gold:#ffd54a; --gold-weak:#ffe9a6;
      --purple:#3b2a7a; --purple-deep:#1a1133; --line:#2a214d; --ring:#3d2e75;
      --ok:#7CFFB6; --warn:#ffd166; --err:#ff6b6b;
      --blue:#4da6ff; --darkblue:#1e3a8a; --red:#ff6060; --burgundy:#8b1e3f;
    }
    html,body{height:100%; margin:0; background:transparent; color:var(--ink);
      font:16px/1.55 'Inter', system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Lienzo de estrellas de fondo */
    #estrellas-canvas{position:fixed; inset:0; width:100vw; height:100vh; display:block; z-index:0; pointer-events:none; background:#000}

    .wrap{max-width:1080px; margin:0 auto; padding:28px 22px; display:block; position:relative; z-index:1}

    /* minúsculas en UI */
    h1,h2,h3,label,button,#toolbar,.mini,.tip,.legend,.serif,#summary{ text-transform: lowercase; }

    /* Formularios */
    .panel{max-width:720px; margin:0 auto; padding:8px 4px 24px}
    h1{font-family:'Spectral SC', Georgia, serif; font-weight:700; letter-spacing:.02em; font-size:30px; margin:0 0 18px 0}
    label{display:block; font-size:13px; color:var(--muted); margin:20px 0 8px}
    input,select{appearance:none; width:100%; padding:12px 0; border:none; border-bottom:1px solid rgba(183,172,214,.25); background:transparent; color:var(--ink); border-radius:0}
    input:focus,select:focus{outline:none; border-bottom-color:var(--gold)}
    .row{display:grid; gap:22px; grid-template-columns:1fr}
    .muted{color:var(--muted)}
    .tip{margin-top:12px; font-size:13px; color:var(--muted)}
    .test{margin-top:14px}
    .pass{color:var(--ok)}
    .fail{color:var(--err)}

    /* CTAs grandes */
    .actionsPrimary{display:flex; justify-content:center; margin-top:30px}
    .btnPrimary{background:none; border:none; color:var(--gold); cursor:pointer; font-weight:800; letter-spacing:.03em; font-size:22px; padding:14px 24px}
    .btnPrimary:hover{color:var(--gold-weak)}
    .actionsSecondary{display:flex; justify-content:center; gap:28px; flex-wrap:wrap; margin-top:14px}
    .btnSecondary{background:none; border:none; color:var(--ink); opacity:.95; cursor:pointer; font-weight:700; letter-spacing:.02em; font-size:17px; padding:8px 10px}
    .btnSecondary:hover{color:var(--gold-weak)}

    /* Toggles ON/OFF (sin bordes visibles) */
    .toggles{display:flex; flex-direction:column; gap:10px}
    .toggle{display:inline-flex; align-items:center; gap:10px; padding:6px 0; border:none; cursor:pointer; user-select:none}
    .toggle input{display:none}
    .toggle .lbl{font-weight:700; letter-spacing:.02em}
    .toggle .pill{font-size:11px; padding:2px 8px; border-radius:999px; border:none; color:var(--muted); background:transparent}
    .toggle.on{color:var(--gold)}
    .toggle.on .pill{background:rgba(255,213,74,.12); color:var(--gold)}

    /* Carta */
    #toolbar{position:sticky; top:0; z-index:5; display:none; padding:10px 0; border-bottom:1px solid rgba(255,213,74,.15);
      background:linear-gradient(180deg, rgba(15,10,27,.85), rgba(15,10,27,.55)); backdrop-filter: blur(6px)}
    #toolbar .bar{max-width:1080px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px}
    #toolbar .brand{font-family:'Spectral SC', Georgia, serif; letter-spacing:.06em}
    #toolbar .actions{display:flex; gap:16px}
    #toolbar .link{background:none; border:none; color:var(--ink); font-weight:700; padding:0; cursor:pointer}
    #toolbar .link:hover{color:var(--gold)}

    .canvasWrap{max-width:1080px; margin:0 auto; display:none}
    .section{margin-top:40px; padding-top:6px}
    .legend{display:grid; grid-template-columns:1fr; gap:10px}
    .legend div{padding:4px 0}
    .serif{font-family:'Spectral SC','Cormorant Garamond', Georgia, serif}

    canvas#chart{width:100%; height:auto; background:
      radial-gradient(900px 900px at 50% 35%, rgba(255,255,255,.04), rgba(0,0,0,0)),
      radial-gradient(1400px 900px at 50% -20%, rgba(77,45,155,.18), rgba(0,0,0,0)),
      #0a0715; border-radius:14px; display:block}

    .mini{font-size:13px; color:var(--muted)}

    /* Estados */
    body.presentation #formZone{display:none}
    body.presentation #toolbar{display:block}
    body.presentation #chartZone{display:block}
  </style>
</head>
<body>
  <!-- Fondo de estrellas -->
  <canvas id="estrellas-canvas"></canvas>

  <!-- Barra presentación -->
  <div id="toolbar">
    <div class="bar">
      <div class="brand serif">☿ carta natal — whole sign</div>
      <div class="actions">
        <button id="btnBack" class="link">editar</button>
        <button id="btnExport" class="link">exportar png</button>
      </div>
    </div>
  </div>

  <!-- Formulario (edición) -->
  <div class="wrap" id="formZone">
    <div class="panel">
      <h1 class="serif">configura tu carta</h1>

      <div class="row">
        <div>
          <label>nombre (opcional)</label>
          <input id="name" placeholder="p.ej. manu"/>
        </div>
        <div>
          <label>zona horaria (iana / ciudades)</label>
          <select id="tzSelect"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>fecha</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>hora</label>
          <input id="time" type="time" step="60" />
          <div class="toggles">
            <label class="toggle" id="tglUnknown"><input type="checkbox" id="chkUnknownTime"><span class="lbl">no conozco mi hora</span><span class="pill" id="stateUnknown">off</span></label>
          </div>
        </div>
      </div>

      <label>localización</label>
      <div class="row">
        <input id="q" placeholder="ciudad, país (p.ej. barcelona, es)">
        <button id="btnGeo" class="btnSecondary">buscar</button>
      </div>

      <div class="row">
        <div>
          <label>latitud (°)</label>
          <input id="lat" type="number" step="0.000001" placeholder="41.388" />
        </div>
        <div>
          <label>longitud (°, este positivo)</label>
          <input id="lon" type="number" step="0.000001" placeholder="2.170" />
        </div>
      </div>

      <div class="row">
        <div>
          <div class="toggles">
            <label class="toggle on" id="tglVisible"><input type="checkbox" id="chkVisible" checked><span class="lbl">sólo planetas visibles (tradicionales)</span><span class="pill" id="stateVisible">on</span></label>
          </div>
        </div>
        <div id="unknownExtras" style="display:none">
          <label>casas con hora desconocida</label>
          <select id="suspectAsc">
            <option value="">— sin casas (no dividir) —</option>
            <option value="0">ascendente sospechado: aries</option>
            <option value="1">ascendente sospechado: tauro</option>
            <option value="2">ascendente sospechado: géminis</option>
            <option value="3">ascendente sospechado: cáncer</option>
            <option value="4">ascendente sospechado: leo</option>
            <option value="5">ascendente sospechado: virgo</option>
            <option value="6">ascendente sospechado: libra</option>
            <option value="7">ascendente sospechado: escorpio</option>
            <option value="8">ascendente sospechado: sagitario</option>
            <option value="9">ascendente sospechado: capricornio</option>
            <option value="10">ascendente sospechado: acuario</option>
            <option value="11">ascendente sospechado: piscis</option>
          </select>
          <div class="mini">si eliges un signo, dibujamos casas <b>whole sign</b> y los <b>aspectos por signos</b> al ascendente sospechado. sin elección, no habrá casas.</div>
        </div>
      </div>

      <div class="actionsPrimary">
        <button id="btnDraw" class="btnPrimary">dibujar carta</button>
      </div>
      <div class="actionsSecondary">
        <button id="btnNow" class="btnSecondary">usar aquí y ahora</button>
        <button id="btnTest" class="btnSecondary">autotest</button>
        <button id="btnExample" class="btnSecondary">cargar ejemplo</button>
      </div>

      <div class="tip">el selector de zona horaria usa ciudades (<i>iana</i>) y ajusta dst automáticamente. si no carga la librería astronómica, el archivo prueba 3 cdns.</div>
      <div id="status" class="tip"></div>
      <div id="testout" class="test"></div>
    </div>
  </div>

  <!-- Carta (presentación) -->
  <div class="wrap canvasWrap" id="chartZone">
    <canvas id="chart" width="1120" height="1120"></canvas>

    <div class="section" id="summary"></div>

    <div class="section">
      <div class="serif" style="letter-spacing:.04em; margin-bottom:6px">qué estás viendo</div>
      <div class="mini">
        <b>dignidades</b>: condiciones clásicas de fuerza/debilidad de los planetas en signos — <i>domicilio</i> (regencia), <i>exaltación</i>, <i>detrimento</i> y <i>caída</i>; si no aplica, <i>peregrino</i>.
        · <b>aspectos (por signos)</b>: distancia entre signos — 2 <i>sextil</i>, 3 <i>cuadratura</i>, 4 <i>trígono</i>, 6 <i>oposición</i>.
        · <b>ángulos</b>: <b>asc</b> une cielo y tierra (oriente, inicio de casa i); <b>mc</b> es la culminación y la obra; <b>dc</b>, occidente y vínculos; <b>ic</b>, raíces y hogar.
      </div>
    </div>

    <div class="section">
      <div class="serif" style="letter-spacing:.04em; margin-bottom:6px">planetas — signo, grado y dignidad</div>
      <div id="readout" class="legend"></div>
    </div>

    <div class="section">
      <div class="serif" style="letter-spacing:.04em; margin-bottom:6px">aspectos al ascendente <span class="mini">(por signos, whole sign)</span></div>
      <div id="ascAspects" class="legend"></div>
    </div>

    <div class="section">
      <div class="serif" style="letter-spacing:.04em; margin-bottom:6px">aspectos entre planetas <span class="mini">(por signos, whole sign)</span></div>
      <div id="ppAspects" class="legend"></div>
    </div>

    <div class="section">
      <div class="serif" style="letter-spacing:.04em; margin-bottom:6px">casas (whole sign)</div>
      <div class="mini" style="margin-bottom:8px">en whole sign cada casa es un signo completo; la casa i empieza en el signo del asc. visión helenística básica de los significados.</div>
      <div id="houses" class="legend serif"></div>
    </div>

    <div class="section" id="anglesInfo"></div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    function setStatus(msg, kind='info'){ const el=$('#status'); if(!el) return; el.textContent = msg; el.style.color = (kind==='error'? '#ff6b6b' : 'var(--muted)'); }
    function roman(n){ const R=['','i','ii','iii','iv','v','vi','vii','viii','ix','x','xi','xii']; return R[n]||String(n); }

    // Loader Astronomy Engine
    async function loadAstronomy(){ if(window.Astronomy) return true; const urls=[
      'https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.browser.min.js',
      'https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.browser.js',
      'https://unpkg.com/astronomy-engine@2.1.0/astronomy.browser.js'];
      for(const url of urls){ try{ await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.defer=true; s.onload=()=>res(); s.onerror=()=>rej(); document.head.appendChild(s); }); if(window.Astronomy) return true; }catch(e){} } return false; }

    // Utilidades astro
    const deg2rad=d=>d*Math.PI/180, rad2deg=r=>(r*180/Math.PI), norm=d=>((d%360)+360)%360;
    function julianDayUTC(date){ let y=date.getUTCFullYear(); let m=date.getUTCMonth()+1; const dayFrac=(date.getUTCHours()+date.getUTCMinutes()/60)/24; let d=date.getUTCDate()+dayFrac; if(m<=2){m+=12; y-=1;} const A=Math.floor(y/100); const B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524.5; }
    function julianCenturies(date){ return (julianDayUTC(date)-2451545)/36525; }
    function obliquityEcliptic(date){ const T=julianCenturies(date); const arcsec=21.448-46.8150*T-0.00059*T*T+0.001813*T*T*T; return 23+26/60+arcsec/3600; }
    function gmstHours(date){ const T=julianCenturies(date); let gmst=(67310.548+(3155760000+8640184.812866)*T+0.093104*T*T-6.2e-6*T*T*T)/3600; return ((gmst%24)+24)%24; }

    function partsToObj(parts){ const o={}; for(const p of parts){ o[p.type]=p.value; } return o; }
    function makeFormatter(tz){ return new Intl.DateTimeFormat('en-US',{timeZone:tz,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
    function localToUTC(tz,Y,M,D,h,m){ let guess=Date.UTC(Y,M-1,D,h,m,0); const f=makeFormatter(tz); for(let i=0;i<4;i++){ const parts=partsToObj(f.formatToParts(new Date(guess))); const got=Date.UTC(+parts.year,+parts.month-1,+parts.day,+parts.hour,+parts.minute,0); const target=Date.UTC(Y,M-1,D,h,m,0); const diff=got-target; if(Math.abs(diff)<1000) break; guess-=diff; } return new Date(guess); }

    function ascendantLongitude(dateUTC, latDeg, lonDeg){ const eps=deg2rad(obliquityEcliptic(dateUTC)); const phi=deg2rad(latDeg); const thetaL=deg2rad(gmstHours(dateUTC)*15 + lonDeg); const num=Math.cos(thetaL); const den=-(Math.sin(thetaL)*Math.cos(eps) + Math.tan(phi)*Math.sin(eps)); return norm(rad2deg(Math.atan2(num, den))); }
    function midheavenLongitude(dateUTC, lonDeg){ const eps=deg2rad(obliquityEcliptic(dateUTC)); const thetaL=deg2rad(gmstHours(dateUTC)*15 + lonDeg); return norm(rad2deg(Math.atan2(Math.sin(thetaL), Math.cos(thetaL)*Math.cos(eps)))); }

    function eclipticLongitude(bodyKey, astroTime){ let vec; if(bodyKey==='Moon') vec=Astronomy.GeoMoon(astroTime); else vec=Astronomy.GeoVector(bodyKey, astroTime, true); const eps=deg2rad(obliquityEcliptic(astroTime.date)); const x=vec.x,y=vec.y,z=vec.z; const ye=y*Math.cos(eps)+z*Math.sin(eps); const xe=x; return norm(rad2deg(Math.atan2(ye, xe))); }
    function formatZodiac(lon){ const s=Math.floor(lon/30); const deg=Math.floor(lon - s*30); const min=Math.floor((lon - s*30 - deg)*60); const glyph=['\u2648\uFE0E','\u2649\uFE0E','\u264A\uFE0E','\u264B\uFE0E','\u264C\uFE0E','\u264D\uFE0E','\u264E\uFE0E','\u264F\uFE0E','\u2650\uFE0E','\u2651\uFE0E','\u2652\uFE0E','\u2653\uFE0E'][s]; const names=['aries','tauro','géminis','cáncer','leo','virgo','libra','escorpio','sagitario','capricornio','acuario','piscis']; return `${deg}°${min.toString().padStart(2,'0')} ${glyph} (${names[s]})`; }

    // Dignidades tradicionales (clásicas)
    const RULERS={0:'Mars',1:'Venus',2:'Mercury',3:'Moon',4:'Sun',5:'Mercury',6:'Venus',7:'Mars',8:'Jupiter',9:'Saturn',10:'Saturn',11:'Jupiter'};
    const EXALT_FULL={0:'Sun',1:'Moon',5:'Mercury',9:'Mars',3:'Jupiter',11:'Venus',6:'Saturn'};
    function dignityOf(planet,sign){ const trad=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn']; if(!trad.includes(planet)) return 'pe'; if(RULERS[sign]===planet) return 'dom'; if(EXALT_FULL[sign]===planet) return 'ex'; const opp=(sign+6)%12; if(RULERS[opp]===planet) return 'det'; if(EXALT_FULL[opp]===planet) return 'fall'; return 'pe'; }
    const DIG_TEXT={ dom:'domicilio', ex:'exaltación', det:'detrimento', fall:'caída', pe:'peregrino' };

    // Aspecto por signos (Whole Sign) usando distancia mínima entre signos.
    function aspectBySigns(signA, signB){ const d=((signB-signA)%12+12)%12; const md=Math.min(d, 12-d); if(md===2) return {type:'sextil', colorName:'darkblue'}; if(md===3) return {type:'cuadratura', colorName:'burgundy'}; if(md===4) return {type:'trígono', colorName:'blue'}; if(md===6) return {type:'oposición', colorName:'red'}; return null; }

    // Dibujo (CCW, I a la izquierda)
    function drawChart(data){
      const canvas=$('#chart'); const ctx=canvas.getContext('2d');
      const W=canvas.width,H=canvas.height; ctx.clearRect(0,0,W,H);
      const cx=W/2, cy=H/2; const R=480, rHouse=410, rPlan=330, rSigns=445, rNums=235;

      // Fondo del canvas rueda (queda encima del fondo de estrellas de la página)
      ctx.save(); ctx.fillStyle='#0a0715'; ctx.fillRect(0,0,W,H); for(let i=0;i<120;i++){ const x=Math.random()*W, y=Math.random()*H, r=Math.random()*1.1; ctx.globalAlpha=Math.random()*0.6+0.2; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle='rgba(255,244,196,.9)'; ctx.fill(); } ctx.globalAlpha=1; ctx.restore();

      const base = Math.PI; // izquierda (Este)
      const toAngRel = relDeg => base - relDeg*Math.PI/180; // CCW
      const SYMBOL_FONT = '600 22px "Noto Sans Symbols 2","Segoe UI Symbol","DejaVu Sans","Symbola",sans-serif';
      const PLANET_FONT = '600 20px "Noto Sans Symbols 2","Segoe UI Symbol","DejaVu Sans","Symbola",sans-serif';

      // Rueda de casas (si hay hora o si hay ascendente sospechado)
      if(!data.unknownTime || data.suspectAscSign!=null){
        for(let i=0;i<12;i++){
          const start= base - i*30*Math.PI/180, end= base - (i+1)*30*Math.PI/180;
          ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,end,true); ctx.closePath();
          ctx.fillStyle = i%2? '#120c26' : '#0d0a1a'; ctx.fill();
        }
        ctx.strokeStyle='rgba(183,172,214,.25)'; ctx.lineWidth=1.2;
        for(let i=0;i<12;i++){ const ang= base - i*30*Math.PI/180; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + R*Math.cos(ang), cy + R*Math.sin(ang)); ctx.stroke(); }
      } else {
        // Sin hora ni sospecha: rueda simple
        ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle='#0d0a1a'; ctx.fill();
      }

      // Bisel interno
      ctx.beginPath(); ctx.arc(cx,cy,rHouse,0,Math.PI*2); ctx.strokeStyle='rgba(183,172,214,.18)'; ctx.lineWidth=1; ctx.stroke();

      // Signos en anillo exterior + números de casa (glifos texto)
      const signGlyph=['\u2648\uFE0E','\u2649\uFE0E','\u264A\uFE0E','\u264B\uFE0E','\u264C\uFE0E','\u264D\uFE0E','\u264E\uFE0E','\u264F\uFE0E','\u2650\uFE0E','\u2651\uFE0E','\u2652\uFE0E','\u2653\uFE0E'];
      for(let i=0;i<12;i++){
        const ang = base - (i+0.5)*30*Math.PI/180; const x=cx + rSigns*Math.cos(ang), y=cy + rSigns*Math.sin(ang)+4;
        const signIndex=(data.ascSign + i)%12; ctx.fillStyle='#ffe9a6'; ctx.font=SYMBOL_FONT; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(signGlyph[signIndex], x, y);
        if(!data.noHouses){ const xn=cx + rNums*Math.cos(ang), yn=cy + rNums*Math.sin(ang); ctx.fillStyle='#d9cef3'; ctx.font='16px "Spectral SC", Georgia, serif'; ctx.fillText(roman(i+1), xn, yn); }
      }

      // Ángulos reales (solo si hay hora)
      if(!data.unknownTime){
        const axis = (label, lon)=>{ const rel=norm(lon - data.house0); const ang=toAngRel(rel); ctx.strokeStyle='#ffd54a'; ctx.lineWidth=1.8; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + R*Math.cos(ang), cy + R*Math.sin(ang)); ctx.stroke(); ctx.save(); ctx.translate(cx + (R+16)*Math.cos(ang), cy + (R+16)*Math.sin(ang)); ctx.rotate(ang+Math.PI/2); ctx.fillStyle='#ffd54a'; ctx.font='bold 11px system-ui'; ctx.textAlign='center'; ctx.fillText(label,0,0); ctx.restore(); };
        axis('mc', data.mc); axis('dc', norm(data.ascDeg+180)); axis('ic', norm(data.mc+180));
      }

      // nodos: planetas + asc (como cápsula)
      const nodes=[];
      for(const p of data.planets){ const rel=norm(p.lon - data.house0); const ang=toAngRel(rel); const x=cx + rPlan*Math.cos(ang), y=cy + rPlan*Math.sin(ang); nodes.push({label:p.name,glyph:p.glyph,lon:p.lon,x,y,sign:p.sign,dig:p.dig,isAsc:false}); }
      let ascNode=null; const canHaveAscNode = (!data.unknownTime) || (data.suspectAscSign!=null);
      if(canHaveAscNode){ const ascSign = (!data.unknownTime) ? Math.floor(data.ascDeg/30) : data.suspectAscSign; const ascRelDeg = (!data.unknownTime) ? norm(data.ascDeg - data.house0) : 0; const a=toAngRel(ascRelDeg); const ax=cx + rPlan*Math.cos(a), ay = cy + rPlan*Math.sin(a); ascNode={label:'asc', glyph:'asc', lon: ascSign*30, x:ax, y:ay, sign:ascSign, isAsc:true}; }

      // líneas de aspectos (por signos)
      if(ascNode){ for(const p of nodes){ const asp=aspectBySigns(ascNode.sign, p.sign); if(asp){ const col=getComputedStyle(document.documentElement).getPropertyValue(`--${asp.colorName}`)||'#fff'; ctx.beginPath(); ctx.moveTo(ascNode.x, ascNode.y); ctx.lineTo(p.x, p.y); ctx.strokeStyle=col; ctx.lineWidth=2.2; ctx.stroke(); } } }
      for(let i=0;i<nodes.length;i++){ for(let j=i+1;j<nodes.length;j++){ const a=nodes[i], b=nodes[j]; const asp=aspectBySigns(a.sign,b.sign); if(asp){ const col=getComputedStyle(document.documentElement).getPropertyValue(`--${asp.colorName}`)||'#fff'; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle=col; ctx.lineWidth=1.6; ctx.stroke(); } } }

      // dibujar nodos
      const PLANET_FONT='600 20px "Noto Sans Symbols 2","Segoe UI Symbol","DejaVu Sans","Symbola",sans-serif';
      for(const n of nodes){ ctx.beginPath(); ctx.arc(n.x,n.y,11,0,Math.PI*2); ctx.fillStyle='#1a1330'; ctx.fill(); ctx.strokeStyle='rgba(255,233,166,.6)'; ctx.lineWidth=1.6; ctx.stroke(); ctx.fillStyle='#fff3c2'; ctx.font=PLANET_FONT; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(n.glyph, n.x, n.y); }
      if(ascNode){ ctx.beginPath(); const w=36,h=18; ctx.roundRect(ascNode.x-w/2, ascNode.y-h/2, w, h, 8); ctx.fillStyle='rgba(255,213,74,.12)'; ctx.fill(); ctx.strokeStyle='#ffd54a'; ctx.lineWidth=1.6; ctx.stroke(); ctx.fillStyle='#ffd54a'; ctx.font='bold 11px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('asc', ascNode.x, ascNode.y); }

      // anillo interior
      ctx.beginPath(); ctx.arc(cx,cy,220,0,Math.PI*2); ctx.strokeStyle='rgba(183,172,214,.18)'; ctx.lineWidth=1; ctx.stroke();
    }

    const PLANETS_ALL=[
      {key:'Sun', glyph:'\u2609', name:'sol'}, {key:'Moon', glyph:'\u263D', name:'luna'}, {key:'Mercury', glyph:'\u263F', name:'mercurio'}, {key:'Venus', glyph:'\u2640', name:'venus'}, {key:'Mars', glyph:'\u2642', name:'marte'}, {key:'Jupiter', glyph:'\u2643', name:'júpiter'}, {key:'Saturn', glyph:'\u2644', name:'saturno'}, {key:'Uranus', glyph:'\u2645', name:'urano'}, {key:'Neptune', glyph:'\u2646', name:'neptuno'}, {key:'Pluto', glyph:'\u2647', name:'plutón'}];
    function getPlanetList(){ return $('#chkVisible').checked ? PLANETS_ALL.slice(0,7) : PLANETS_ALL; }

    function computePlanets(utc, list){ const t=new Astronomy.AstroTime(utc); return list.map(p=>{ const lon=eclipticLongitude(p.key,t); const sign=Math.floor(lon/30); const dig=dignityOf(p.key,sign); return {name:p.name,key:p.key,glyph:p.glyph,lon,sign,dig}; }); }

    function assignHouses(planets,ascSign){ const houses=Array.from({length:12},()=>({sign:null,planets:[]})); for(let i=0;i<12;i++){ houses[i].sign=(ascSign+i)%12; } for(const p of planets){ const s=Math.floor(p.lon/30); for(let h=0;h<12;h++){ if(houses[h].sign===s){ houses[h].planets.push(p); break; } } } return houses; }

    const HOUSE_MEANINGS=[
      'vida, cuerpo, apariencia',
      'recursos, dinero, sustento',
      'hermanos, entorno cercano, viajes cortos',
      'hogar, raíces, padre/madre, fin de las cosas',
      'placer, creatividad, hijos',
      'esfuerzo, enfermedad, servicio',
      'pareja, acuerdos, aliados',
      'muerte, deudas, bienes compartidos',
      'dioses, fe, estudios, extranjero',
      'obra, rango, profesión, reputación',
      'amistades, grupos, dones',
      'lo oculto, retiro, enemigos, aflicciones'
    ];

    function computeAndDraw(){
      if(!window.Astronomy){ setStatus('no se ha cargado astronomy engine.', 'error'); return; }
      const name=$('#name').value.trim(); const dateStr=$('#date').value; if(!dateStr){ setStatus('→ falta fecha.'); return; }
      const lat=parseFloat($('#lat').value), lon=parseFloat($('#lon').value); if(isNaN(lat)||isNaN(lon)){ setStatus('→ faltan coordenadas.'); return; }
      const tz=$('#tzSelect').value; const unknown=$('#chkUnknownTime').checked; const suspectStr=$('#suspectAsc').value; const suspectAscSign = (unknown && suspectStr!=='' ? parseInt(suspectStr,10) : null);
      const [Y,M,D]=dateStr.split('-').map(Number); let utc;
      if(unknown){ utc=localToUTC(tz,Y,M,D,12,0); } else { const timeStr=$('#time').value||'12:00'; const [hh,mm]=timeStr.split(':').map(Number); utc=localToUTC(tz,Y,M,D,hh,mm||0); }

      const plist = getPlanetList();
      const planets=computePlanets(utc, plist);

      let ascDeg=null,mc=null,ascSign,house0,noHouses=false;
      if(unknown){ if(suspectAscSign!=null){ ascSign=suspectAscSign; house0=ascSign*30; } else { ascSign=0; house0=0; noHouses=true; } }
      else { ascDeg=ascendantLongitude(utc,lat,lon); mc=midheavenLongitude(utc,lon); ascSign=Math.floor(ascDeg/30); house0=ascSign*30; }

      drawChart({planets,house0,ascSign,ascDeg,mc,unknownTime:unknown,noHouses,suspectAscSign});

      // resumen + ángulos
      const summary=$('#summary'); const tzName=tz; const ts = unknown? '— hora desconocida (asumimos 12:00)' : ($('#time').value||'12:00');
      const ascText = unknown? (suspectAscSign!=null? `<b>asc:</b> <i>sospechado</i> ${['aries','tauro','géminis','cáncer','leo','virgo','libra','escorpio','sagitario','capricornio','acuario','piscis'][suspectAscSign]}` : '<b>asc:</b> <i>desconocido</i>') : `<b>asc:</b> ${formatZodiac(ascDeg)}`;
      const mcText  = unknown? '<b>mc:</b> <i>desconocido</i>'  : `<b>mc:</b> ${formatZodiac(mc)}`;
      summary.innerHTML = `<div><b>${name||'carta natal'}</b> — ${dateStr} ${ts} ${tzName} · lat ${lat.toFixed(4)}°, lon ${lon.toFixed(4)}°</div>
                           <div class="mini">${ascText} · ${mcText}</div>`;

      const angles=$('#anglesInfo'); angles.innerHTML = `
        <div class="mini">
          <b>asc</b> une cielo y tierra en tu nacimiento (oriente), abre la casa i. <b>mc</b> es la culminación/obra.
          <b>dc</b> es el occidente y los vínculos (casa vii). <b>ic</b> habla del hogar, raíces y cierres.
        </div>`;

      // Planetas (leyenda)
      const ro=$('#readout'); ro.innerHTML='';
      for(const p of planets){ const d=document.createElement('div'); const dig= DIG_TEXT[p.dig]; d.innerHTML=`<div><span>${p.glyph} ${p.name}</span> · <span class="muted">${formatZodiac(p.lon)}</span> · <span>${dig}</span></div>`; ro.appendChild(d); }

      // Aspectos al asc (por signos)
      const ascBox=$('#ascAspects'); ascBox.innerHTML='';
      const canAspectsList = (!unknown) || (suspectAscSign!=null);
      if(canAspectsList){ const ascSignEff = (!unknown) ? Math.floor(ascDeg/30) : suspectAscSign; for(const p of planets){ const asp=aspectBySigns(ascSignEff, p.sign); if(asp){ const item=document.createElement('div'); item.innerHTML=`<div><span>${p.glyph} ${p.name}</span> — <b>${asp.type}</b></div>`; item.style.color = getComputedStyle(document.documentElement).getPropertyValue(`--${asp.colorName}`) || '#fff'; ascBox.appendChild(item); } } if(!ascBox.children.length){ ascBox.innerHTML = '<div class="mini">no hay aspectos principales al ascendente por signos.</div>'; } } else { ascBox.innerHTML = '<div class="mini">no se calculan aspectos al asc sin hora ni ascendente sospechado.</div>'; }

      // Aspectos planeta↔planeta (por signos)
      const pp=$('#ppAspects'); pp.innerHTML='';
      for(let i=0;i<planets.length;i++){
        for(let j=i+1;j<planets.length;j++){
          const A=planets[i], B=planets[j]; const asp=aspectBySigns(A.sign, B.sign); if(asp){ const row=document.createElement('div'); row.innerHTML=`<div>${A.glyph} ${A.name} ↔ ${B.glyph} ${B.name} — <b>${asp.type}</b></div>`; row.style.color=getComputedStyle(document.documentElement).getPropertyValue(`--${asp.colorName}`)||'#fff'; pp.appendChild(row); }
        }
      }
      if(!pp.children.length){ pp.innerHTML='<div class="mini">no hay aspectos por signos entre los planetas seleccionados.</div>'; }

      // Casas (una columna con significado helenístico breve)
      const hs=$('#houses'); hs.innerHTML=''; const signNames=['aries','tauro','géminis','cáncer','leo','virgo','libra','escorpio','sagitario','capricornio','acuario','piscis'];
      if(!noHouses){ const houses=assignHouses(planets,ascSign); for(let i=0;i<12;i++){ const h=houses[i]; const div=document.createElement('div'); const plist=h.planets.length? h.planets.map(p=>`${p.glyph} ${p.name}`).join(' · ') : '<span class="muted">—</span>'; div.innerHTML=`<b class="serif" style="font-size:18px">casa ${roman(i+1)}</b> — ${signNames[h.sign]} · <span class="muted">${HOUSE_MEANINGS[i]}</span><br/><span class="muted">planetas:</span> ${plist}`; hs.appendChild(div); } }
      else { hs.innerHTML = '<div class="mini">casas: <i>no disponibles</i> (hora desconocida y sin ascendente sospechado).</div>'; }

      document.body.classList.add('presentation');
    }

    // Geocoder OSM
    async function geocode(){ const q=$('#q').value.trim(); if(!q) return; setStatus('buscando…'); try{ const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`; const res=await fetch(url,{headers:{'Accept-Language':'es'}}); const arr=await res.json(); if(arr&&arr.length){ $('#lat').value=parseFloat(arr[0].lat).toFixed(6); $('#lon').value=parseFloat(arr[0].lon).toFixed(6); setStatus(`📍 ${arr[0].display_name}`);} else setStatus('no encontrado.'); }catch(e){ setStatus('error de red al geocodificar.','error'); } }

    // TZ selector (IANA)
    function populateTZ(){ const sel=$('#tzSelect'); sel.innerHTML=''; let zones=[]; if(Intl.supportedValuesOf){ try{ zones=Intl.supportedValuesOf('timeZone'); }catch(_){} } if(!zones||zones.length===0){ zones=['Europe/Madrid','Europe/Paris','Europe/London','Europe/Rome','Europe/Berlin','Europe/Lisbon','UTC','Africa/Casablanca','Africa/Johannesburg','America/Sao_Paulo','America/Argentina/Buenos_Aires','America/Mexico_City','America/Bogota','America/Lima','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Asia/Tokyo','Asia/Seoul','Asia/Shanghai','Asia/Hong_Kong','Asia/Kolkata','Asia/Bangkok','Asia/Dubai','Australia/Sydney']; }
      const current= Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; for(const z of zones){ const opt=document.createElement('option'); opt.value=z; opt.textContent=z; if(z===current) opt.selected=true; sel.appendChild(opt);} }

    function fillNow(){ populateTZ(); const d=new Date(); $('#date').valueAsDate=new Date(d.getFullYear(),d.getMonth(),d.getDate()); $('#time').value=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{ $('#lat').value=pos.coords.latitude.toFixed(6); $('#lon').value=pos.coords.longitude.toFixed(6); setStatus('coordenadas obtenidas del dispositivo.'); },()=>{}, {enableHighAccuracy:true,timeout:4000}); } }

    function exportPNG(){ const canvas=$('#chart'); const a=document.createElement('a'); a.download='carta_whole_sign.png'; a.href=canvas.toDataURL('image/png'); a.click(); }

    // UI switches
    function updateSwitchUI(){
      const vis=$('#chkVisible').checked; const unk=$('#chkUnknownTime').checked;
      const tVisible=$('#tglVisible'); const tUnknown=$('#tglUnknown');
      const sVis=$('#stateVisible'); const sUnk=$('#stateUnknown');
      if(tVisible){ tVisible.classList.toggle('on', vis); if(sVis) sVis.textContent = vis? 'on' : 'off'; }
      if(tUnknown){ tUnknown.classList.toggle('on', unk); if(sUnk) sUnk.textContent = unk? 'on' : 'off'; }
      $('#unknownExtras').style.display = unk? 'block':'none';
      const time=$('#time'); if(time) time.disabled = unk;
    }

    // Autotest (igual + tests de aspectos)
    function addTestLine(msg, ok){ const el=document.createElement('div'); el.innerHTML=`${ok?'✅':'❌'} <span class="${ok?'pass':'fail'}">${msg}</span>`; const box=$('#testout'); if(box) box.appendChild(el); }
    function clearTests(){ const box=$('#testout'); if(box) box.innerHTML=''; }
    function runTests(){
      clearTests();
      addTestLine('carga de astronomy engine', !!window.Astronomy);
      if(!window.Astronomy){ addTestLine('sin astronomy no se pueden calcular planetas.', false); return; }
      try{ const utc=new Date(Date.UTC(2024,0,1,12,0,0)); const t=new Astronomy.AstroTime(utc); const bodies=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto']; let okAll=true; for(const b of bodies){ const lon=eclipticLongitude(b,t); if(!(isFinite(lon)&&lon>=0&&lon<360)) okAll=false; } addTestLine('longitudes planetarias dentro de [0,360)', okAll);}catch(e){ addTestLine('error longitudes: '+e.message,false); }
      try{ const utc=new Date(Date.UTC(2024,5,1,12,0,0)); const asc=ascendantLongitude(utc,41.387,2.170); const mc=midheavenLongitude(utc,2.170); addTestLine('asc rango [0,360)', asc>=0&&asc<360); addTestLine('mc rango [0,360)', mc>=0&&mc<360);}catch(e){ addTestLine('error en asc/mc: '+e.message,false); }
      const digsOK = dignityOf('Mars',0)==='dom' && dignityOf('Sun',0)==='ex' && dignityOf('Saturn',6)==='ex' && dignityOf('Saturn',3)==='det'; addTestLine('dignidades: reglas base', digsOK);
      try{ const A=0; const expect=(s,kind)=>(aspectBySigns(A,s)||{}).type===kind; const okSxt=expect(2,'sextil'); const okSqr=expect(3,'cuadratura'); const okTri=expect(4,'trígono'); const okOpp=expect(6,'oposición'); addTestLine('aspectos por signos (2/3/4/6)', okSxt&&okSqr&&okTri&&okOpp); const sym=(a,b)=>{const x=aspectBySigns(a,b), y=aspectBySigns(b,a); return (!x&&!y)||(x&&y&&x.type===y.type);}; addTestLine('aspectos por signos simétricos', sym(0,4)&&sym(0,6)&&sym(1,3)); }catch(e){ addTestLine('error aspectos por signos: '+e.message,false); }
    }

    // Listeners
    $('#btnGeo').addEventListener('click', geocode);
    $('#btnDraw').addEventListener('click', computeAndDraw);
    $('#btnNow').addEventListener('click', ()=>{ fillNow(); setStatus(''); });
    $('#btnTest').addEventListener('click', runTests);
    $('#btnExample').addEventListener('click', ()=>{ $('#name').value='ejemplo'; $('#date').value='1997-02-28'; $('#time').value='15:40'; $('#lat').value='36.600000'; $('#lon').value='-6.216667'; setStatus('ejemplo cargado.'); });
    $('#chkUnknownTime').addEventListener('change', updateSwitchUI);
    $('#chkVisible').addEventListener('change', updateSwitchUI);

    // Toolbar
    $('#btnBack').addEventListener('click', ()=>{ document.body.classList.remove('presentation'); });
    $('#btnExport').addEventListener('click', exportPNG);

    (async function init(){ fillNow(); updateSwitchUI(); setStatus('cargando librería astronómica…'); const ok=await loadAstronomy(); setStatus(ok? 'librería lista.' : 'no se pudo cargar astronomy engine.', (ok?'info':'error')); })();

    // ===== Fondo de estrellas (tomado y adaptado de tu index) =====
    const sky = document.getElementById('estrellas-canvas');
    const sctx = sky.getContext('2d');
    function resizeSky(){ sky.width = window.innerWidth; sky.height = window.innerHeight; }
    resizeSky(); window.addEventListener('resize', ()=>{ resizeSky(); stars = makeStars(); consts = makeConstellations(); });

    const STAR_COUNT = Math.floor(window.innerWidth*window.innerHeight/1500);
    const CONSTELLATIONS = ()=> Math.floor(Math.random()*4)+10;
    const GROUP_SIZES=[4,5,6,7,8,9,10];

    function makeStars(){ const arr=[]; for(let i=0;i<STAR_COUNT;i++){ arr.push({ x:Math.random()*sky.width, y:Math.random()*sky.height, r:Math.random()*0.7+0.6, a:Math.random()*0.7+0.3, ph:Math.random()*Math.PI*2 }); } return arr; }
    function flicker(e,t){ return e.a*(0.93 + 0.07*Math.sin(t*0.37 + e.ph)); }

    function makeConstellations(){ const list=[]; for(let i=0;i<CONSTELLATIONS();i++){ const num = GROUP_SIZES[Math.floor(Math.random()*GROUP_SIZES.length)]; const cx = Math.random()*(sky.width*0.8)+sky.width*0.1; const cy = Math.random()*(sky.height*0.8)+sky.height*0.1; const rg = Math.min(sky.width,sky.height)*(0.10+Math.random()*0.08); const used=new Set(); const nodes=[]; let attempts=0; while(nodes.length<num && attempts<200){ const ang=Math.random()*2*Math.PI; const rr=Math.random()*rg*0.85; const x=cx+Math.cos(ang)*rr, y=cy+Math.sin(ang)*rr; let best=null,bd=1e9; for(let j=0;j<stars.length;j++){ if(used.has(j)) continue; const e=stars[j]; const d=Math.hypot(e.x-x,e.y-y); if(d<bd){ bd=d; best=j; } } if(best!==null){ used.add(best); nodes.push(best);} attempts++; } const edges=[]; if(nodes.length>1){ let connected=[0]; let rest=Array.from({length:nodes.length},(_,i)=>i).slice(1); while(rest.length){ let bd=1e9, fi=null, ti=null; for(const i of connected){ for(const j of rest){ const A=stars[nodes[i]], B=stars[nodes[j]]; const d=Math.hypot(A.x-B.x,A.y-B.y); if(d<bd){ bd=d; fi=i; ti=j; } } } edges.push([fi,ti]); connected.push(ti); rest=rest.filter(x=>x!==ti); } } if(nodes.length>4 && Math.random()>0.5){ const a=Math.floor(Math.random()*nodes.length); const b=(a+2+Math.floor(Math.random()*(nodes.length-3)))%nodes.length; if(!edges.some(([x,y]) => (x===a&&y===b)||(x===b&&y===a))){ edges.push([a,b]); } } list.push({nodes,edges}); } return list; }

    let stars = makeStars();
    let consts = makeConstellations();

    function paintSky(t){ sctx.clearRect(0,0,sky.width,sky.height); for(const e of stars){ sctx.save(); sctx.beginPath(); sctx.arc(e.x,e.y,e.r,0,Math.PI*2); sctx.globalAlpha=flicker(e,t/1000); sctx.fillStyle='#fff'; sctx.shadowColor='#fff'; sctx.shadowBlur=6+e.a*14; sctx.fill(); sctx.restore(); } for(const c of consts){ sctx.save(); sctx.strokeStyle='rgba(255,255,255,0.44)'; sctx.lineWidth=1.2; sctx.setLineDash([1,5]); sctx.beginPath(); for(const [i1,i2] of c.edges){ const A=stars[c.nodes[i1]], B=stars[c.nodes[i2]]; sctx.moveTo(A.x,A.y); sctx.lineTo(B.x,B.y);} sctx.stroke(); sctx.setLineDash([]); sctx.restore(); } requestAnimationFrame(paintSky); }
    requestAnimationFrame(paintSky);
  </script>
</body>
</html>
